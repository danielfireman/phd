---
title: "FPCC2 Atividade 2 Milestone 3"
author: "Daniel Fireman (danielfireman@gmail.com)"
date: "April 2016"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

```{r echo=TRUE, message=FALSE}
require("dplyr")
require("ggplot2")
require("cowplot")
require("ggbiplot")
require("reshape2")
require("Rtsne")
```

## Anpalise exploratória inicial

Vamos discutir os tipos de gastos. Para tal, selecionamos as seguintes variáveis:

* codLegislatura: Indica a que legislatura pertence a despesa
* txtDescricao: Categoria que identifica o gasto
* sgPartido: Partido que pertence o parlamentar que efetuou a despesa
* sgUF: Sigla do estado associado ao parlamentar que efetuou a despesa
* vlrLiquido: Valor líquido da despesa

```{r echo=TRUE, message=FALSE}
d <- read.csv("../a1m2/AnoAtual.csv", stringsAsFactors = FALSE)
d %>% select(codLegislatura, vlrLiquido) %>% summary()
```

Uma análise inicial dos dados escolhidos nos mostra que:

* Temos dados de duas legislaturas (54 e 55): escolhemos trabalhar apenas com a legislatura 55
* O valor líquido tem possui valores negativos: esse fato acontece em geral quando há devolução de dinheiro (i.e. passagem cancelada). Como proporcionalmente esse valor equivale a menos de 1% do total de gastos escolhemos trabalhar apenas com valores positivos.

```{r echo=TRUE, message=FALSE}
d <- d %>% filter(codLegislatura == 55 & vlrLiquido > 0)

aggregate(vlrLiquido ~ txtDescricao, d , "sum") %>% arrange(desc(vlrLiquido))
```

Com a agregação acima, vemos também que existem duas categorias relacionadas só que com nomes diferentes: "Emissão Bilhete Aéreo" e "PASSAGENS AÉREAS". Optamos por agregar esses dois tipos:

```{r echo=TRUE, message=FALSE}
index <- d$txtDescricao == "Emissão Bilhete Aéreo"
d$txtDescricao[index] <- "PASSAGENS AÉREAS"

aggregate(vlrLiquido ~ txtDescricao, d , "sum") %>% arrange(desc(vlrLiquido))
```

## Redução de dimensionalidade

Um problema que temos é a grande quantidade de tipos de despesas (mesmo para uma redução de dimensionalidade). Olhando mais uma vez a visão agregada visão agregada vemos que os top 4 tipos de despesas correspondem a quase 60% do total de despesas. Optamos por usar esses 4 e agregar os demais tipos:

```{r echo=TRUE, message=FALSE}
index.outros <- d$txtDescricao != "DIVULGAÇÃO DA ATIVIDADE PARLAMENTAR." &
  d$txtDescricao != "PASSAGENS AÉREAS" &
  d$txtDescricao != "MANUTENÇÃO DE ESCRITÓRIO DE APOIO À ATIVIDADE PARLAMENTAR" &
  d$txtDescricao != "LOCAÇÃO OU FRETAMENTO DE VEÍCULOS AUTOMOTORES"
d$txtDescricao[index.outros] <- "OUTROS"
aggregate(vlrLiquido ~ txtDescricao, d , "sum") %>% arrange(desc(vlrLiquido))
```

O próximo passo é transformar os dados no formato largo. Uma grande dificuldade encontrada foi achar um identificador único para cada entrada. Um exemplo de erros nos dados que dificultaram essa operação segue abaixo:

```{r echo=TRUE, message=FALSE}
filter(d, numLote == 1168083)
```

Como não faz sentido colocar valor como identificador, vamos utilizar a soma como função de agregação e finalmente temos os dados em formato largo:

```{r echo=TRUE, message=FALSE}
d.wide <- dcast(d,
  numMes+numAno+numParcela+numSubCota+
  txtNumero+numLote+datEmissao+numRessarcimento+
  sgPartido+sgUF+ideCadastro+txtCNPJCPF~txtDescricao,
  value.var = "vlrLiquido",
  fun.aggregate = sum) %>%
  select(-numMes, -numAno, -numParcela,
         -numSubCota, -txtNumero, -numLote,
         -datEmissao, -numRessarcimento, -ideCadastro,
         -txtCNPJCPF)

summary(d.wide)
```

E seguimos com o cálculo do PCA:

```{r echo=TRUE, message=FALSE}
d.pca <- prcomp(d.wide[,3:7], scale. = TRUE, center=TRUE)
summary(d.pca)
```

Para diminuir os danos causados pelo *skewness* dos dados, usamos os parâmetros *scale* e *center* no cálculo do PCA. Com o resumo da primeira interação, podemos notar que todos os componentes colaboram de forma muito parecida para explicação da variância total. Abaixo vemos o gráfico que mostra a quase linearidade da proporção cumulativa da variância:

```{r echo=TRUE, message=FALSE, fig.asp=0.5}
plot_pve <- function(prout){
  pr.var <- prout$sdev^2
  pve <- pr.var / sum(pr.var)
  df = data.frame(x = 1:NROW(pve), y = cumsum(pve))
  ggplot(df, aes(x = x, y = y)) + 
    geom_point(size = 3) + 
    geom_line() + 
    labs(x='Componente Principal', y = 'Proporção Cumulativa da Variância') +
    theme_bw() +
    scale_y_continuous(breaks = seq(0, 1, by=0.2)) +
    scale_x_continuous(breaks = seq(0, 5))
}
plot_pve(d.pca)
```

De forma geral, esse gráfico nos mostra que cada um dos tipos de despesas contribui de forma relativamente igual a variância do total de despesas.

```{r echo=TRUE, message=FALSE, fig.asp=0.5}
ggbiplot(d.pca, obs.scale = 1, var.scale = 1, ellipse = TRUE, circle = TRUE) +
  theme_bw()

d.wide.unique <- unique(d.wide)
set.seed(42)
tsne.out <- Rtsne(d.wide.unique, verbose = TRUE, max_iter = 500)
d.tsne <- as.data.frame(tsne.out$Y)
d.tsne$uf = d.wide.unique$sgUF
d.tsne$partido = d.wide.unique$sgPartido

ggplot(d.tsne, aes(x = V1, y = V2)) + 
  geom_point(alpha = 0.2, color = "tomato") 
```